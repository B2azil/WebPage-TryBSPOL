<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>B&S Polska - Szczegóły produktu</title>
  <link rel="icon" href="img/bspolska.png">
  <meta name="description" content="">
  <link rel="stylesheet" href="css/product.css">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js"></script>
  <script src="script/Accordion.js"></script>
</head>
<body>
  <div class="product-container" id="productDetails">
    <p>Ładowanie danych produktu...</p>
  </div>

<script type="module">
  async function loadProductDetails() {
    const params = new URLSearchParams(window.location.search);
    const prodId = params.get('id');
    const brand = params.get('brand');

    if (!prodId) {
      document.title = 'Nie podano produktu - B&S Polska';
      document.getElementById('productDetails').innerHTML = '<p>Nie podano produktu. <a href="index.html">Wróć do strony głównej</a>.</p>';
      return;
    }

    const csvPath = brand ? `brand/brand_${brand}.csv` : await detectBrandCSV();
    const cacheKey = `productData_${brand || 'default'}`; // Poprawione: Obsługa braku brand
    const cacheTimestampKey = `productData_${brand || 'default'}_timestamp`;
    const cacheDuration = 24 * 60 * 60 * 1000; // 24 godziny

    try {
      let products;
      const cachedData = localStorage.getItem(cacheKey);
      const cachedTimestamp = localStorage.getItem(cacheTimestampKey);
      const now = Date.now();

      if (cachedData && cachedTimestamp && (now - parseInt(cachedTimestamp) < cacheDuration)) {
        products = JSON.parse(cachedData);
      } else {
        const response = await fetch(csvPath);
        if (!response.ok) throw new Error(`Nie udało się pobrać pliku CSV: ${csvPath}`);
        const data = await response.text();

        const results = Papa.parse(data, {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: false,
          delimiter: ';'  // ustaw separator na średnik
        });

        // Poprawione: Walidacja wyników parsowania
        if (!results.data || !Array.isArray(results.data) || results.data.length === 0) {
          throw new Error('Plik CSV jest pusty lub nieprawidłowy');
        }

        products = results.data; // Poprawione: Przypisanie do zmiennej zewnętrznej
        localStorage.setItem(cacheKey, JSON.stringify(products));
        localStorage.setItem(cacheTimestampKey, now.toString());
      }

      // Odnajdź produkt po nazwie (prodId jest w URL zakodowane, więc dekoduj)
      const decodedProdId = decodeURIComponent(prodId);
      const product = products.find(p => p.name === decodedProdId);

      if (!product) {
        document.title = 'Produkt nie znaleziony - B&S Polska';
        document.getElementById('productDetails').innerHTML = '<p>Produkt nie znaleziony. <a href="index.html">Wróć do strony głównej</a>.</p>';
        return;
      }

      // Ustaw dynamiczny tytuł strony (z sanitizacją)
      document.title = `${DOMPurify.sanitize(product.name)} - B&S Polska`;

      // Ustaw dynamiczny meta description (z sanitizacją)
      document.querySelector('meta[name="description"]').setAttribute('content', DOMPurify.sanitize(product.category) || `Produkt marki ${DOMPurify.sanitize(product.brand)}`);

      // Dynamiczne wyświetlanie dostępnych zdjęć z CSV (sanitizuj ścieżki)
      const imageBasePath = `img/${DOMPurify.sanitize(product.brand)}/`;
      const images = [
        product.image, product.image2, product.image3,
        product.image4, product.image5, product.image6,
        product.image7, product.image8
      ].filter(src => src && src.trim() !== '')
       .map(src => imageBasePath + DOMPurify.sanitize(src));

      const galleryHtml = `
        <div class="gallery">
          <div class="thumbnails" role="tablist">
            ${images.map((src, i) => `
              <div class="thumb-box">
                <img src="${src}" data-index="${i}" alt="${DOMPurify.sanitize(product.name)} - zdjęcie ${i + 1} miniatura" tabindex="0" loading="lazy" role="tab" aria-selected="${i === 0 ? 'true' : 'false'}">
              </div>
            `).join('')}
          </div>
          <div class="main-image">
            <div class="image-box">
              <img id="currentImage" src="${images[0]}" alt="${DOMPurify.sanitize(product.name)} - zdjęcie 1" role="img" aria-label="Zdjęcie produktu: ${DOMPurify.sanitize(product.name)}, 1 z ${images.length}">
            </div>
          </div>
        </div>
      `;

      // Opis (sanitizuj text)
      const infoFields = [
        'info1','info2','info3','info4',
        'info5','info6','info7','info8',
        'info9','info10','info11','info12',
        'info13','info14','info15'
      ];
      const infosHtml = infoFields
        .map(field => product[field])
        .filter(text => text && text.trim() !== '')
        .map(text => `<p class="description">- ${DOMPurify.sanitize(text)}</p>`)
        .join('');

      // Tablica logo sklepów (stała dla wszystkich produktów) – sanitizacja niepotrzebna, bo stałe dane
      const shops = [
        { src: 'https://erli.pl/sprzedawcy/assets/images/logo-shop.svg', alt: 'erli', link: 'https://erli.pl/sklep/BandSPolska/33689'},
        { src: 'https://upload.wikimedia.org/wikipedia/commons/4/40/Kaufland_2016_horizontal.svg', alt: 'kaufland', link: 'https://www.kaufland.pl/shops/BandSPolska/'},
        { src: 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b7/Empik.svg/330px-Empik.svg.png', alt: 'empik', link: 'https://www.empik.com/sklepy/b-s-polska,3078,m'},
        { src: 'https://upload.wikimedia.org/wikipedia/commons/9/9b/OLX_2019.svg', alt: 'OLX', link: 'https://www.olx.pl/oferty/uzytkownik/1PcRlD/'},
        { src: 'https://upload.wikimedia.org/wikipedia/commons/a/a9/Amazon_logo.svg', alt: 'amazon', link: 'https://www.amazon.pl/s?me=A10IUM9O23CD0Y&marketplaceID=A1C3SOZRARQ6R3'},
        { src: 'https://arena.pl/dist/img/logo-arena.svg', alt: 'arena', link: 'https://arena.pl/sprzedawca/b_and_s_polska/sklep'}
      ];
      
      const logosHtml = shops.map(shop => `
        <a href="${shop.link}" target="_blank" rel="noopener noreferrer">
          <img src="${shop.src}" alt="${shop.alt}" class="shop-logo">
        </a>
      `).join('');

      // Render (sanitizuj całość)
      const renderHtml = `
        <div class="header">
          <a href="brand.html?brand=${DOMPurify.sanitize(product.brandPage || 'index.html')}" class="back-link"><i class="fa fa-long-arrow-left"></i> Powrót do listy produktów marki ${DOMPurify.sanitize(product.brand)}</a>
        </div>
        <main class="product-page">
          ${galleryHtml}
          <section class="product-details">
            <h1 class="name">${DOMPurify.sanitize(product.name)}</h1>
            <span class="sku">SKU: ${DOMPurify.sanitize(product.sku)}</span>
            <div class="category">Kategoria: ${DOMPurify.sanitize(product.category)}</div>
            <div class="price">Cena rekomendowana: ${DOMPurify.sanitize(product.price)} zł</div>
            <div>
              <div class="brand">Marka: ${DOMPurify.sanitize(product.brand)}</div>
              <h3>Produkt dostępny w sklepie:</h3>
              <a href="${DOMPurify.sanitize(product.link)}" target="_blank" rel="noopener noreferrer" class="link"><img src="https://upload.wikimedia.org/wikipedia/commons/c/c3/Allegro.pl_sklep.svg" alt="Allegro"></a>
              oraz może być dostępny w <a class="club" href="${DOMPurify.sanitize(product.fanstoreLink)}" target="_blank" rel="noopener noreferrer" class="link"><img src="${DOMPurify.sanitize(product.logoClub)}" alt="fanstore" loading="lazy"></a>
              <div class="logo-sale">
                <h4>oraz można znaleźć w</h4>${logosHtml}
              </div>
            </div>
            <div class="accordion">
              <div class="accordion-item">
                <button class="accordion-header" role="button" aria-expanded="false" aria-controls="desc-content" title="lista opisu produktu">Opis produktu</button>
                <div class="accordion-content" id="desc-content" aria-hidden="true">
                    ${infosHtml}
                </div>
              </div>
              <div class="accordion-item">
                <button class="accordion-header" role="button" aria-expanded="false" aria-controls="spec-content" title="lista szczegółów produktu">Specyfikacja techniczna produktu</button>
                <div class="accordion-content" id="spec-content" aria-hidden="true">
                    <p>Wysokość: ${DOMPurify.sanitize(product.height)} cm</p>
                    <p>Szerokość: ${DOMPurify.sanitize(product.width)} cm</p>
                    <p>Głębokość: ${DOMPurify.sanitize(product.depth)} cm</p>
                    <p>Waga produktu: ${DOMPurify.sanitize(product.weight)} g</p>
                    <p>Materiał: ${DOMPurify.sanitize(product.material)}</p>
                    <p>Kolor dominujący: ${DOMPurify.sanitize(product.color)}</p>
                    <p>EAN (GTIN) produktu: ${DOMPurify.sanitize(product.BarCode)}</p>
                </div>
              </div>
            </div>
          </section>
        </main>
      `;
      document.getElementById('productDetails').innerHTML = DOMPurify.sanitize(renderHtml);

      // --- JS obsługa galerii ---
      const thumbs = document.querySelectorAll('.thumb-box img');
      const thumbBoxes = document.querySelectorAll('.thumb-box');
      const currentImg = document.getElementById('currentImage');
      let currentIndex = 0;

      function updateImage(index) {
        currentImg.src = images[index];
        thumbBoxes.forEach(b => b.classList.remove('active'));
        thumbBoxes[index].classList.add('active');
        currentIndex = index;
        currentImg.alt = `${DOMPurify.sanitize(product.name)} - zdjęcie ${index + 1}`;
        currentImg.setAttribute('aria-label', `Zdjęcie produktu: ${DOMPurify.sanitize(product.name)}, ${index + 1} z ${images.length}`);
        thumbs.forEach(t => t.setAttribute('aria-selected', 'false'));
        thumbs[index].setAttribute('aria-selected', 'true');
      }

      thumbs.forEach((thumb, i) => {
        thumb.setAttribute('tabindex', '0');
        thumb.addEventListener('click', () => updateImage(i));
        thumb.addEventListener('mouseenter', () => {
          if (!('ontouchstart' in window)) updateImage(i);
        });
        thumb.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') updateImage(i);
        });
      });

      const imageBox = document.querySelector('.main-image .image-box');
      // Dodane: Wyłącz zoom na urządzeniach dotykowych
      if (!('ontouchstart' in window)) {
        imageBox.addEventListener('mousemove', (e) => {
          const rect = imageBox.getBoundingClientRect();
          const x = ((e.clientX - rect.left) / rect.width) * 100;
          const y = ((e.clientY - rect.top) / rect.height) * 100;
          currentImg.style.transformOrigin = `${x}% ${y}%`;
          currentImg.style.transform = "scale(2)";
        });
        imageBox.addEventListener('mouseleave', () => {
          currentImg.style.transform = "scale(1)";
          currentImg.style.transformOrigin = "center center";
        });
      }

      // Full-Screen Image
      function openFullscreen() {
        const fullscreenDiv = document.createElement('div');
        fullscreenDiv.className = 'fullscreen-image';
        fullscreenDiv.innerHTML = DOMPurify.sanitize(`
          <img src="${images[currentIndex]}" alt="${DOMPurify.sanitize(product.name)} - zdjęcie ${currentIndex + 1}">
          <button title="Zamknij galerię" aria-label="Zamknij galerię" class="close-button">×</button>
          <button title="Poprzednie zdjęcie" aria-label="Poprzednie zdjęcie" class="nav-arrow prev"><i class="fa fa-arrow-left"></i></button>
          <button title="Następne zdjęcie" aria-label="Następne zdjęcie" class="nav-arrow next"><i class="fa fa-arrow-right"></i></button>
        `);
        document.body.appendChild(fullscreenDiv);

        const fullscreenImg = fullscreenDiv.querySelector('img');
        const closeButton = fullscreenDiv.querySelector('.close-button');
        const prevButton = fullscreenDiv.querySelector('.nav-arrow.prev');
        const nextButton = fullscreenDiv.querySelector('.nav-arrow.next');

        // Dodaj ARIA dla dialogu i fokus na closeButton
        fullscreenDiv.setAttribute('role', 'dialog');
        fullscreenDiv.setAttribute('aria-modal', 'true');
        fullscreenDiv.setAttribute('aria-label', 'Galeria pełnoekranowa produktu');
        closeButton.focus(); // Fokus na przycisku zamykania

        // Dodane: Pinch-to-zoom
        let scale = 1;
        let lastDistance = 0;
        fullscreenImg.style.transform = `scale(${scale})`;

        fullscreenDiv.addEventListener('touchstart', (e) => {
          if (e.touches.length === 2) {
            lastDistance = Math.hypot(
              e.touches[0].pageX - e.touches[1].pageX,
              e.touches[0].pageY - e.touches[1].pageY
            );
          }
        });

        fullscreenDiv.addEventListener('touchmove', (e) => {
          if (e.touches.length === 2) {
            e.preventDefault();
            const currentDistance = Math.hypot(
              e.touches[0].pageX - e.touches[1].pageX,
              e.touches[0].pageY - e.touches[1].pageY
            );
            const delta = currentDistance - lastDistance;
            scale = Math.max(1, Math.min(scale + delta * 0.01, 3));
            fullscreenImg.style.transform = `scale(${scale})`;
            lastDistance = currentDistance;
          }
        });

        function updateFullscreenImage(index) {
          currentIndex = (index < 0) ? images.length - 1 : (index >= images.length) ? 0 : index;
          fullscreenImg.src = images[currentIndex];
          fullscreenImg.alt = `${DOMPurify.sanitize(product.name)} - zdjęcie ${currentIndex + 1}`;
          thumbBoxes.forEach(b => b.classList.remove('active'));
          thumbBoxes[currentIndex].classList.add('active');
          currentImg.src = images[currentIndex];
          prevButton.style.display = 'block';
          nextButton.style.display = 'block';
          scale = 1; // Reset skali przy zmianie obrazu
          fullscreenImg.style.transform = `scale(${scale})`;
        }

        prevButton.addEventListener('click', () => updateFullscreenImage(currentIndex - 1));
        nextButton.addEventListener('click', () => updateFullscreenImage(currentIndex + 1));

        function handleKeyNavigation(e) {
          if (e.key === 'ArrowLeft') {
            updateFullscreenImage(currentIndex - 1);
          } else if (e.key === 'ArrowRight') {
            updateFullscreenImage(currentIndex + 1);
          } else if (e.key === 'Escape') {
            fullscreenDiv.remove();
            document.removeEventListener('keydown', handleKeyNavigation);
          }
        }

        // Swipe navigation
        let touchStartX = 0;
        let touchEndX = 0;

        fullscreenDiv.addEventListener('touchstart', (e) => {
          touchStartX = e.changedTouches[0].screenX;
        });

        fullscreenDiv.addEventListener('touchend', (e) => {
          touchEndX = e.changedTouches[0].screenX;
          const swipeDistance = touchEndX - touchStartX;
          if (Math.abs(swipeDistance) > 50) {
            if (swipeDistance > 0 && currentIndex > 0) {
              updateFullscreenImage(currentIndex - 1);
            } else if (swipeDistance < 0 && currentIndex < images.length - 1) {
              updateFullscreenImage(currentIndex + 1);
            }
          }
        });

        // Close on click outside image or close button
        fullscreenDiv.addEventListener('click', (e) => {
          if (e.target === fullscreenDiv || e.target === closeButton) {
            fullscreenDiv.remove();
            document.removeEventListener('keydown', handleKeyNavigation);
          }
        });

        // Add keydown listener for arrow keys
        document.addEventListener('keydown', handleKeyNavigation);
      }

      imageBox.addEventListener('click', openFullscreen);

      // Swipe Gestures for Main Image
      let touchStartX = 0;
      let touchEndX = 0;

      imageBox.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
      });

      imageBox.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        const swipeDistance = touchEndX - touchStartX;
        if (Math.abs(swipeDistance) > 50) {
          if (swipeDistance > 0 && currentIndex > 0) {
            updateImage(currentIndex - 1);
          } else if (swipeDistance < 0 && currentIndex < images.length - 1) {
            updateImage(currentIndex + 1);
          }
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        const accordionHeaders = document.querySelectorAll(".accordion-header");
        accordionHeaders.forEach(header => {
          const content = header.nextElementSibling;
          header.addEventListener("click", () => {
            const isExpanded = header.getAttribute("aria-expanded") === "true";
            header.setAttribute("aria-expanded", String(!isExpanded));
            content.setAttribute("aria-hidden", String(isExpanded));
            content.style.display = isExpanded ? "none" : "block";
          });
        });
      });

      const thumbnails = document.querySelectorAll('.thumbnails img');
      const currentImage = document.getElementById('currentImage');

      thumbnails.forEach((thumb, index) => {
        thumb.addEventListener('click', () => {
          // Zmień źródło głównego obrazu
          currentImage.src = thumb.src;
          currentImage.alt = thumb.alt.replace('miniatura', 'główne zdjęcie');
          currentImage.setAttribute('aria-label', `Zdjęcie produktu: ${DOMPurify.sanitize(product.name)}, ${index + 1} z ${images.length}`);

          // Zaktualizuj aria-selected dla miniatur
          thumbnails.forEach(t => t.setAttribute('aria-selected', 'false'));
          thumb.setAttribute('aria-selected', 'true');
        });
      });
    } catch (error) {
      // Dodane: Szczegółowa obsługa błędów
      let errorMessage = '';
      if (error.message.includes('Nie udało się pobrać')) {
        errorMessage = `Nie można załadować danych produktu z pliku ${csvPath}. <button onclick="window.location.reload()">Spróbuj ponownie</button> lub <a href="index.html">wróć do strony głównej</a>.`;
      } else if (error.message.includes('Failed to parse') || error.message.includes('Plik CSV jest pusty')) {
        errorMessage = `Błąd parsowania danych produktu z pliku ${csvPath}. Skontaktuj się z administratorem lub <a href="index.html">wróć do strony głównej</a>.`;
      } else {
        errorMessage = `Wystąpił nieoczekiwany błąd: ${DOMPurify.sanitize(error.message)}. <a href="index.html">Wróć do strony głównej</a>.`;
      }
      document.getElementById('productDetails').innerHTML = `<p>${errorMessage}</p>`;
      console.error(`Błąd ładowania produktu (CSV: ${csvPath}):`, error);
    }
  }

  async function detectBrandCSV() {
    try {
      const response = await fetch('brand/');
      const html = await response.text();
      const match = html.match(/brand_[\w-]+\.csv/);
      return match ? `brand/${match[0]}` : 'brand/brand_default.csv';
    } catch {
      return 'brand/brand_South.csv';
    }
  }

  loadProductDetails();
</script>
</body>
</html>