<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Glassmorphism Header</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="css/main2.css">
  <style>
    /* Header z glassmorphism */
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      padding: 1rem 5%;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.22);
      z-index: 1000;
      transition: all 0.3s ease;
    }

    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 1400px;
      margin: 0 auto;
      position: relative;
    }

    /* Logo */
    .logo {
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
      text-decoration: none;
      letter-spacing: 1px;
    }

    .logo span {
      color: #00d4ff;
    }

    /* Desktop nav - na środku */
    .desktop-nav {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 3rem;
    }

    .nav-link {
      color: white;
      text-decoration: none;
      font-weight: 500;
      font-size: 1.1rem;
      transition: all 0.3s ease;
      position: relative;
    }

    .nav-link a{
        color: white;
        text-decoration: none;
    }

    .nav-link::after {
      content: '';
      position: absolute;
      width: 0;
      height: 2px;
      bottom: -8px;
      left: 50%;
      background: #00d4ff;
      transition: all 0.3s ease;
      transform: translateX(-50%);
    }

    .nav-link:hover::after {
      width: 100%;
    }

    /* Mobile menu button */
    .mobile-toggle {
      display: none;
      background: none;
      border: none;
      font-size: 1.8rem;
      color: white;
      cursor: pointer;
      z-index: 1001;
    }

    /* Mobile menu (off-canvas z lewej) */
    .mobile-menu {
      position: fixed;
      top: 0;
      left: -300px;
      width: 300px;
      height: 100vh;
      background: rgba(10, 10, 30, 0.95);
      backdrop-filter: blur(15px);
      padding: 100px 30px 40px;
      transition: left 0.4s cubic-bezier(0.77, 0, 0.18, 1);
      z-index: 999;
    }

    .mobile-menu.active {
      left: 0;
    }

    .mobile-menu a {
      display: block;
      color: white;
      text-decoration: none;
      font-size: 1.4rem;
      padding: 1rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      transition: all 0.3s;
    }

    .mobile-menu a:hover {
      color: #00d4ff;
      padding-left: 15px;
    }

    /* Overlay */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      opacity: 0;
      visibility: hidden;
      transition: all 0.4s;
      z-index: 998;
    }

    .overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* Responsywność */
    @media (max-width: 992px) {
      .desktop-nav {
        display: none;
      }

      .mobile-toggle {
        display: block;
      }

      .navbar {
        justify-content: space-between;
      }
    }

    /* Dodatkowy efekt przy scrollu */
    header.scrolled {
      /* background: rgba(20, 20, 40, 0.28); */
      padding: 0.8rem 5%;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>

<header id="main-header" class="header">
  <div class="header-container">
    <!-- Logo -->
    <a href="https://b2azil.github.io/WebPage-TryBSPOL/" aria-label="Wróć na początek strony" class="logo-link">
      <img src="main/img/bspolska.png" alt="Logo B&S Polska" class="logo">
    </a>
    
    <!-- Desktop Navigation -->
    <nav class="desktop-nav" aria-label="Nawigacja główna">
      <a href="#about" class="nav-link">O nas</a>
      <a href="#portfolio" class="nav-link">Portfolio</a>
      <a href="#buy" class="nav-link">Gdzie kupić</a>
      <a href="#contact" class="nav-link">Kontakt</a>
    </nav>
    
    <!-- Mobile Menu Button -->
    <button class="hamburger" id="hamburgerBtn" aria-label="Otwórz menu" aria-expanded="false" aria-controls="mobileNav">
      <span class="hamburger-box">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </span>
    </button>
  </div>
  
  <!-- Mobile Navigation Canvas -->
  <div class="mobile-menu-container">
    <!-- Overlay -->
    <div class="menu-overlay" id="menuOverlay" aria-hidden="true"></div>
    
    <!-- Canvas Menu -->
    <nav class="mobile-nav canvas-style" id="mobileNav" aria-label="Nawigacja mobilna" aria-hidden="true">
      <div class="mobile-nav-header">
        <button class="close-menu" id="closeMenuBtn" aria-label="Zamknij menu">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      
      <div class="mobile-nav-content">
        <a href="#about" class="nav-link mobile-nav-link">
          <span class="nav-link-text">O nas</span>
        </a>
        <a href="#portfolio" class="nav-link mobile-nav-link">
          <span class="nav-link-text">Portfolio</span>
        </a>
        <a href="#buy" class="nav-link mobile-nav-link">
          <span class="nav-link-text">Gdzie kupić</span>
        </a>
        <a href="#contact" class="nav-link mobile-nav-link">
          <span class="nav-link-text">Kontakt</span>
        </a>
      </div>
    </nav>
  </div>

  <style>
    :root {
      --primary-color: #00c01d;
      --accent-color: #00911C;
      --text-color: #ffffff;
      --glass-bg: linear-gradient(135deg, rgba(25, 25, 25, 0.35) 0%, rgba(25, 25, 25, 0.25) 100%);
      --glass-border: rgba(255, 255, 255, 0.2);
      --glass-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
      --transition-speed: 0.4s;
      --blur-max: 22px;
      --blur-min: 10px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;

    }

    /* GLASSMORPHIC HEADER */
    
    .header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      background: var(--glass-bg);
      /* background: rgba(20, 20, 40, 0.28); */
      padding: 0.8rem 5%;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      backdrop-filter: blur(var(--blur-max));
      -webkit-backdrop-filter: blur(var(--blur-max));
      border-bottom: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      transition: all var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
      padding: 15px 40px;
    }

    .header:hover {
      backdrop-filter: blur(var(--blur-min));
      -webkit-backdrop-filter: blur(var(--blur-min));
      box-shadow: 0 12px 40px rgba(31, 38, 135, 0.2);
    }

    .header.scrolled {
        background-color: rgba(20, 20, 40, 0.38);
        /* background-color: var(--glass-bg); */
      padding: 10px 40px;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* LOGO */
    .logo-link {
      display: flex;
      align-items: center;
      text-decoration: none;
      transition: transform 0.3s ease;
    }

    .logo-link:hover {
      transform: scale(1.05);
    }

    .logo {
      height: 50px;
      width: auto;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    /* DESKTOP NAVIGATION */
    .desktop-nav {
      display: flex;
      gap: 40px;
    }

    .nav-link {
      color: var(--text-color);
      text-decoration: none;
      font-size: 18px;
      font-weight: 500;
      position: relative;
      padding: 8px 0;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 8px 16px;
    }

    .nav-link::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 0;
      height: 2px;
      background: var(--accent-color);
      transition: all 0.3s ease;
      transform: translateX(-50%);
    }

    .nav-link:hover {
        color:fff;
      transform: translateY(-2px);
    }

    .nav-link:hover::after {
      width: 80%;
    }

    /* HAMBURGER MENU */
    .hamburger {
      display: none;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      z-index: 1001;
      position: relative;
    }

    .hamburger-box {
      width: 30px;
      height: 24px;
      display: inline-block;
      position: relative;
    }

    .hamburger-line {
      width: 100%;
      height: 3px;
      background-color: var(--text-color);
      position: absolute;
      left: 0;
      border-radius: 3px;
      transition: all 0.3s ease;
    }

    .hamburger-line:nth-child(1) {
      top: 0;
    }

    .hamburger-line:nth-child(2) {
      top: 50%;
      transform: translateY(-50%);
    }

    .hamburger-line:nth-child(3) {
      bottom: 0;
    }

    .hamburger[aria-expanded="true"] .hamburger-line:nth-child(1) {
      transform: translateY(10px) rotate(45deg);
    }

    .hamburger[aria-expanded="true"] .hamburger-line:nth-child(2) {
      opacity: 0;
    }

    .hamburger[aria-expanded="true"] .hamburger-line:nth-child(3) {
      transform: translateY(-10px) rotate(-45deg);
    }

    /* MOBILE MENU CANVAS */
    .mobile-menu-container {
      display: none;
    }

    /* Overlay */
    .menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-speed) ease;
      z-index: 999;
    }

    .menu-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    /* Canvas Menu */
    .mobile-nav {
      position: fixed;
      top: 0;
      left: -320px;
      width: 300px;
      height: 100%;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-right: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      z-index: 1000;
      padding: 20px;
      transition: left var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
    }

    .mobile-nav.open {
      left: 0;
    }

    .mobile-nav-header {
      display: flex;
      justify-content: flex-end;
      padding-bottom: 30px;
    }

    .close-menu {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      color: var(--text-color);
      transition: transform 0.3s ease;
    }

    .close-menu:hover {
      transform: rotate(90deg);
    }

    .mobile-nav-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding-top: 20px;
    }

    .mobile-nav-link {
      display: flex;
      align-items: center;
      padding: 16px 24px;
      border: 2px solid transparent;
      border-radius: 12px;
      transition: all 0.3s ease;
      text-align: left;
      background: rgba(255, 255, 255, 0.1);
    }

    .mobile-nav-link:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: var(--accent-color);
      transform: translateX(8px);
    }

    .nav-link-text {
      font-size: 20px;
      font-weight: 500;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .header {
        padding: 12px 20px;
      }
      
      .header.scrolled {
        padding: 8px 20px;
      }
      
      .logo {
        height: 40px;
      }
      
      .desktop-nav {
        display: none;
      }
      
      .hamburger {
        display: block;
      }
      
      .mobile-menu-container {
        display: block;
      }
      
      body {
        padding-top: 64px;
      }
    }

    @media (max-width: 480px) {
      .mobile-nav {
        width: 85%;
        left: -100%;
      }
      
      .mobile-nav.open {
        left: 0;
      }
      
      .nav-link-text {
        font-size: 18px;
      }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      
      .header,
      .mobile-nav,
      .menu-overlay {
        transition: none;
      }
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const hamburger = document.getElementById('hamburgerBtn');
      const closeBtn = document.getElementById('closeMenuBtn');
      const mobileNav = document.getElementById('mobileNav');
      const menuOverlay = document.getElementById('menuOverlay');
      const header = document.getElementById('main-header');
      const navLinks = document.querySelectorAll('.nav-link');

      // Toggle mobile menu
      function toggleMenu() {
        const isOpen = mobileNav.classList.contains('open');
        
        if (!isOpen) {
          mobileNav.classList.add('open');
          menuOverlay.classList.add('open');
          hamburger.setAttribute('aria-expanded', 'true');
          mobileNav.setAttribute('aria-hidden', 'false');
          document.body.style.overflow = 'hidden';
        } else {
          closeMenu();
        }
      }

      // Close menu function
      function closeMenu() {
        mobileNav.classList.remove('open');
        menuOverlay.classList.remove('open');
        hamburger.setAttribute('aria-expanded', 'false');
        mobileNav.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }

      // Event listeners
      hamburger.addEventListener('click', toggleMenu);
      closeBtn.addEventListener('click', closeMenu);
      menuOverlay.addEventListener('click', closeMenu);

      // Close menu on link click
      navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const targetId = this.getAttribute('href');
          const targetElement = document.querySelector(targetId);
          
          if (targetElement) {
            targetElement.scrollIntoView({
              behavior: 'smooth'
            });
          }
          
          closeMenu();
        });
      });

      // Scroll effect for header
      let lastScroll = 0;
      window.addEventListener('scroll', () => {
        const currentScroll = window.pageYOffset;
        
        if (currentScroll > 100) {
          header.classList.add('scrolled');
        } else {
          header.classList.remove('scrolled');
        }
        
        lastScroll = currentScroll;
      });

      // Close menu on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && mobileNav.classList.contains('open')) {
          closeMenu();
        }
      });

      // Handle window resize
      window.addEventListener('resize', () => {
        if (window.innerWidth > 768 && mobileNav.classList.contains('open')) {
          closeMenu();
        }
      });

      // Handle hover effect on mobile devices
      header.addEventListener('touchstart', function() {
        this.style.backdropFilter = `blur(${getComputedStyle(this).getPropertyValue('--blur-min')})`;
        this.style.webkitBackdropFilter = `blur(${getComputedStyle(this).getPropertyValue('--blur-min')})`;
      });

      header.addEventListener('touchend', function() {
        this.style.backdropFilter = '';
        this.style.webkitBackdropFilter = '';
      });

      // Handle hover for non-touch devices
      if (!('ontouchstart' in window)) {
        header.addEventListener('mouseenter', function() {
          this.style.backdropFilter = `blur(${getComputedStyle(this).getPropertyValue('--blur-min')})`;
          this.style.webkitBackdropFilter = `blur(${getComputedStyle(this).getPropertyValue('--blur-min')})`;
        });

        header.addEventListener('mouseleave', function() {
          this.style.backdropFilter = `blur(${getComputedStyle(this).getPropertyValue('--blur-max')})`;
          this.style.webkitBackdropFilter = `blur(${getComputedStyle(this).getPropertyValue('--blur-max')})`;
        });
      }
    });
  </script>
</header>
  

<section id="hero-section">
  <div class="hero" id="hero">
    <div class="hero-bg" id="bg1"></div> <!-- Górny (aktywny) -->
    <div class="hero-bg" id="bg2"></div> <!-- Dolny (następny) -->
    
    <div class="hero-content"> <!-- Kontener na treść, na wierzchu -->
      <div class="hero-text">
        <h1>B&S Polska - Wysokiej jakości tekstylia szkolne</h1>
        <p>Odkryj nasze podukty licencyjne.</p>
      </div>
      <!-- <img src="main/img/bspolska.png" class="logo"> -->
      <img id="hero-img" style="display: none;" src="" alt="Initial description"> <!-- Ukryty obraz dla dostępności -->
      <a href="#portfolio" class="hero-cta">Przeglądaj marki</a>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const bg1 = document.getElementById('bg1');
      const bg2 = document.getElementById('bg2');
      const heroImg = document.getElementById('hero-img');

      let activeBg = bg1;
      let inactiveBg = bg2;
      let currentIndex = 0;
      let intervalId = null;

      const intervalTime = 5000;
      const maxRunTime = 1 * 30 * 60 * 1000; // 30 minut

      // Funkcja fallbacku
      function setFallback() {
        const fallback = "fallback.jpg";
        activeBg.style.backgroundImage =
          `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('${fallback}')`;
        if (heroImg) {
          heroImg.src = fallback;
          heroImg.alt = "Domyślne tło";
        }
      }

      // Funkcja zmiany tła
      function changeBackground(images) {
        const nextImage = images[currentIndex];
        inactiveBg.style.backgroundImage =
          `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('${nextImage.url}')`;
        inactiveBg.style.opacity = 1;
        activeBg.style.opacity = 0;

        if (heroImg) {
          heroImg.src = nextImage.url;
          heroImg.alt = nextImage.desc;
        }

        setTimeout(() => {
          [activeBg, inactiveBg] = [inactiveBg, activeBg];
        }, 1000);

        currentIndex = (currentIndex + 1) % images.length;
      }

      // Ładuj CSV
      fetch("main/csv/images.csv")
        .then(response => {
          if (!response.ok) throw new Error("Błąd ładowania CSV");
          return response.text();
        })
        .then(text => {
          const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
          if (lines.length <= 1) {
            console.error("Brak danych w CSV");
            setFallback();
            return;
          }

          // Usuń nagłówek
          lines.shift();

          const images = lines.map(line => {
            const parts = line.split(";");
            if (parts.length < 2) {
              console.warn("Niepoprawna linia:", line);
              return null;
            }
            return { url: parts[0].trim(), desc: parts.slice(1).join(";").trim() };
          }).filter(Boolean);

          if (images.length === 0) {
            console.error("Brak poprawnych obrazów");
            setFallback();
            return;
          }

          // Inicjalizacja pierwszego tła
          activeBg.style.backgroundImage =
            `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('${images[0].url}')`;
          activeBg.style.opacity = 1;
          inactiveBg.style.opacity = 0;
          if (heroImg) {
            heroImg.src = images[0].url;
            heroImg.alt = images[0].desc;
          }
          currentIndex = 1;

          // Uruchom interwał, jeśli więcej niż 1 obraz
          if (images.length > 1) {
            intervalId = setInterval(() => changeBackground(images), intervalTime);
          }

          // Preload obrazów
          images.forEach(item => {
            const img = new Image();
            img.src = item.url;
            img.onerror = () => console.warn("Nie udało się załadować:", item.url);
          });

          // Limit działania
          setTimeout(() => {
            if (intervalId) {
              clearInterval(intervalId);
              console.log("Interwał zatrzymany po 2h");
            }
          }, maxRunTime);

          // Pauza, gdy karta nieaktywna
          document.addEventListener("visibilitychange", () => {
            if (document.hidden && intervalId) {
              clearInterval(intervalId);
              intervalId = null;
              console.log("Interwał zatrzymany (karta nieaktywna)");
            } else if (!document.hidden && !intervalId && images.length > 1) {
              intervalId = setInterval(() => changeBackground(images), intervalTime);
              console.log("Interwał wznowiony (karta aktywna)");
            }
          });
        })
        .catch(err => {
          console.error("Błąd fetch:", err);
          setFallback();
        });
    });
  </script>
</section>

<section id="about" class="about">
    <h2>O nas</h2>
    <p>B&S Polska oferuje dobrej jakości i w umiarkowanych cenach tekstylia szkolne. Jest wieloletnim, doświadczonym i rzetelnym dostawcą marek licencyjnych jak i własnych.</p>
</section>

<section id="atuty" class="atuty">
  <div class="atuty-container">
    <h2>Dlaczego nasze produkty?</h2>
    <p class="atuty-subtitle">Nasza obietnica to więcej niż słowa. To realne wartości, które znajdziesz w każdym produkcie.</p>
    
    <div class="atuty-grid">
      
      <div class="atut-card">
        <i class="fa fa-shield" aria-hidden="true"></i>
        <h3>Jakość i Bezpieczeństwo</h3>
        <p>Używamy certyfikowanych materiałów (np. 300D RECYCLEX), ekologiczne i bezpieczne dla dzieci. Dajemy Ci pewność najlepszego wyboru.</p>
      </div>

      <div class="atut-card">
        <i class="fa fa-star" aria-hidden="true"></i>
        <h3>Oficjalne Licencje</h3>
        <p>Jako rzetelny partner, gwarantujemy 100% autentyczności. Wszystkie produkty marek (Legia Warszawa, Lech Poznań, Pogoń Szczecin) posiadają oficjalną licencję.</p>
      </div>
      
      <div class="atut-card">
        <i class="fa fa-wrench" aria-hidden="true"></i>
        <h3>Niezawodność i Trwałość</h3>
        <p>Projektujemy z myślą o energii dzieci. Mocne szwy, wytrzymałe zamki i solidne tkaniny to nasz absolutny standard.</p>
      </div>
      
      <div class="atut-card">
        <i class="fa fa-paint-brush" aria-hidden="true"></i>
        <h3>Marki Własne</h3>
        <p>Oprócz Licencjonowanych produktów, tworzymy własne, oryginalne kolekcje (South, Tech).</p>
      </div>

      <div class="atut-card">
        <i class="fa fa-quora" aria-hidden="true"></i>
        <h3>Super Sprzedawca</h3>
        <p>Możemy pochwalić się średnią ocen na allegro wysoszącą 100% polecających, jak i bycia supersprzedawcą wg allegro.</p>
      </div>

    </div>
  </div>
</section>

<section id="portfolio">
  <h3>Portfolio</h3>
  <div class="brand-grid">
    <p class="loading">Ładowanie marek...</p>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const gridContainer = document.querySelector('.brand-grid');

      // Funkcja slugify (bezpieczne URL)
      function slugify(text) {
          const map = {
          'ą':'a','ć':'c','ę':'e','ł':'l','ń':'n',
          'ó':'o','ś':'s','ź':'z','ż':'z',
          'Ą':'a','Ć':'c','Ę':'e','Ł':'l','Ń':'n',
          'Ó':'o','Ś':'s','Ź':'z','Ż':'z'
          };
        return String(text || '')
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // pozostałe akcenty
          .replace(/[ąćęłńóśźżĄĆĘŁŃÓŚŹŻ]/g, m => map[m] || m) // zamiana PL znaków
          .toLowerCase()
          .replace(/\s+/g, '-')            // spacje → -
          .replace(/[^\w-]+/g, '')         // inne znaki
          .replace(/--+/g, '-')            // wielokrotne - do jednego
          .replace(/^-+|-+$/g, '');        // usunięcie - z początku/końca
      }

      // Walidacja kolorów
      function isValidColor(str) {
        const s = new Option().style;
        s.color = str;
        return s.color !== '';
      }

      // Tworzenie kafelka marki
      function createBrandTile(row) {
        if (!row.name) return null; // pomijamy wiersze bez nazwy

        const tile = document.createElement('a');
        tile.className = 'brand-tile';

        // Generowanie linku na podstawie sluga
        const slug = slugify(row.name) || 'unknown';
        tile.href = `brand.html?brand=${encodeURIComponent(slug)}`;
        tile.setAttribute("aria-label", row.name);
        tile.setAttribute('title', `Przejdź do listy produktów marki ${row.name}`);

        // Ustawienie kolorów z fallbackami
        tile.style.setProperty('--color1', row.color1 && isValidColor(row.color1) ? row.color1 : '#f9f9f9');
        tile.style.setProperty('--color2', row.color2 && isValidColor(row.color2) ? row.color2 : '#f9f9f9');
        tile.style.setProperty('--color3', row.color3 && isValidColor(row.color3) ? row.color3 : '#f9f9f9');


        // Nazwa marki
        const nameSpan = document.createElement('span');
        nameSpan.textContent = row.name;
        tile.appendChild(nameSpan);

        return tile;
      }
      // Główna funkcja ładowania i renderowania
      async function loadBrands() {
        const gridContainer = document.querySelector('.brand-grid'); // Przeniesione tutaj dla spójności

        try {
          const response = await fetch('main/csv/brands.csv');
          if (!response.ok) throw new Error('Nie udało się załadować pliku CSV');

          const text = await response.text();
          const results = Papa.parse(text, { 
            header: true, 
            skipEmptyLines: true,
            delimiter: ";" 
          });


          if (results.errors.length > 0) {
            throw new Error('Błąd parsowania CSV: ' + results.errors[0].message);
          }

          gridContainer.innerHTML = ''; // Wyczyszczenie "Ładowanie..."

          const fragment = document.createDocumentFragment();

          results.data.forEach(row => {
            const tile = createBrandTile(row);
            if (tile) fragment.appendChild(tile);
          });

          gridContainer.appendChild(fragment);
        } catch (error) {
          console.error('Błąd:', error);
          gridContainer.innerHTML = '<p>❌ Nie udało się załadować marek.</p>';
        }
      }

      // Wywołanie funkcji bezpośrednio (zamiast drugiego listenera)
      loadBrands();
    });
  </script>
</section>

<section id="carousel">
  <div class="logo-carousel">
    <div class="logo-track" id="logoTrack"></div>
  </div>
<script>
    (function () {
      const config = {
        csvUrl: 'main/csv/carousel.csv', // Ścieżka do pliku CSV
        imageBasePath: 'main/img/', // Prefiks dla wszystkich obrazów
        fallbackImage: 'main/img/fallback-logo.png', // Zastępczy obraz w folderze main/img
        speed: 1.2, // px na klatkę (prędkość animacji)
        direction: 'left', // 'left' lub 'right'
        logos: [], // Będzie wypełnione po parsowaniu CSV
        cycleWidth: 0, // Szerokość jednego cyklu (obliczona dynamicznie po załadowaniu obrazów)
      };

      const carousel = document.getElementById('logoTrack');
      const wrapper = carousel?.parentNode;

      // Walidacja elementów DOM
      if (!carousel || !wrapper) {
        console.error('Nie znaleziono elementów karuzeli (logoTrack) lub wrappera (logo-carousel). Sprawdź HTML.');
        return;
      }

      // Funkcja debounce dla optymalizacji resize
      function debounce(fn, wait) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => fn.apply(this, args), wait);
        };
      }

      // Asynchroniczna funkcja wypełniania logotypów (z czekaniem na załadowanie obrazów)
      async function fillLogos() {
        if (config.logos.length === 0) {
          console.error('Brak logotypów do załadowania. Sprawdź CSV.');
          return;
        }

        let repetitions = 0;
        carousel.innerHTML = ''; // Wyczyść
        const allImgs = []; // Zbieraj obrazy do czekania na onload

        // Pętla do powielania aż tor będzie wystarczająco długi
        do {
          config.logos.forEach((item) => {
            const img = document.createElement('img');
            img.src = item.src;
            img.alt = item.alt || 'Logo'; // Domyślny alt z CSV lub fallback
            img.onerror = () => {
              console.warn(`Błąd ładowania obrazu: ${item.src}. Używam fallback.`);
              img.src = config.fallbackImage;
            };
            carousel.appendChild(img);
            allImgs.push(img); // Dodaj do listy do czekania
          });
          repetitions++;
        } while (carousel.scrollWidth < wrapper.offsetWidth * 2);

        // Czekaj na załadowanie wszystkich obrazów (lub błędy)
        await Promise.all(allImgs.map(img => new Promise((resolve) => {
          img.onload = resolve;
          img.onerror = resolve; // Kontynuuj nawet po błędzie
          if (img.complete) resolve(); // Jeśli już załadowany (z cache)
        })));

        // Po załadowaniu: Oblicz szerokość jednego cyklu precyzyjnie
        config.cycleWidth = carousel.scrollWidth / repetitions;
        console.log(`Wypełniono karuzelę: ${repetitions} powtórzeń, cycleWidth: ${config.cycleWidth}px (po załadowaniu obrazów)`);
      }

      // Funkcja animacji (z konfigurowalnym kierunkiem i precyzyjnym resetem)
      let position = 0;
      let speedLocked = false;

      function animate() {
        if (!speedLocked && config.cycleWidth > 0) {
          const effectiveSpeed = config.direction === 'left' ? -config.speed : config.speed;
          position += effectiveSpeed;

          // Precyzyjny reset pozycji dla płynnego zapętlania
          if (config.direction === 'left') {
            if (position <= -config.cycleWidth) {
              position += config.cycleWidth; // Dodaj cycleWidth zamiast =0, aby uniknąć przeskoku
            }
          } else {
            if (position >= config.cycleWidth) {
              position -= config.cycleWidth;
            }
          }
        }
        carousel.style.transform = `translateX(${position}px)`;
        requestAnimationFrame(animate);
      }

      // Obsługa hover (zatrzymanie animacji)
      wrapper.addEventListener('mouseenter', () => {
        speedLocked = true;
      });
      wrapper.addEventListener('mouseleave', () => {
        speedLocked = false;
      });

      // Obsługa dotyku (swipe dla mobilnych z lepszym ograniczeniem pozycji)
      let touchStartX = 0;
      wrapper.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
        speedLocked = true;
      });
      wrapper.addEventListener('touchmove', (e) => {
        e.preventDefault(); // Zapobiegaj scrollowi strony
        const touchX = e.touches[0].clientX;
        const deltaX = touchX - touchStartX;
        position += deltaX; // Zwiększona wrażliwość dla lepszego swipe (dostosuj jeśli za szybko)
        touchStartX = touchX;

        // Ogranicz pozycję do zakresu cyklu, aby uniknąć przeskoków poza granicami
        position = ((position % config.cycleWidth) + config.cycleWidth) % config.cycleWidth;
        if (config.direction === 'left' && position > 0) position -= config.cycleWidth;

        carousel.style.transform = `translateX(${position}px)`;
      });
      wrapper.addEventListener('touchend', () => {
        speedLocked = false;
      });

      // Obsługa resize okna (ponowne asynchroniczne wypełnienie karuzeli)
      const debouncedResize = debounce(async () => {
        await fillLogos();
        // Reset pozycji po resize, aby uniknąć przeskoków
        position = 0;
      }, 200);
      window.addEventListener('resize', debouncedResize);

      // Ładowanie i parsowanie CSV za pomocą PapaParse
      Papa.parse(config.csvUrl, {
        download: true, // Pobierz plik zdalnie/lokalnie
        header: true, // Użyj pierwszej linii jako nagłówki (image, alt)
        skipEmptyLines: true, // Pomiń puste wiersze
        dynamicTyping: false, // Traktuj wszystko jako stringi
        complete: (results) => {
          console.log('CSV załadowany pomyślnie:', results.data.length, 'wierszy');
          if (results.errors && results.errors.length > 0) {
            console.error('Błędy parsowania CSV:', results.errors);
            return;
          }
          // Przetwórz dane: filtruj puste src i stwórz tablicę obiektów
          config.logos = results.data
            .map((row) => ({
              src: row.image?.trim() ? `${config.imageBasePath}${row.image.trim()}` : '', // Dodaj prefiks
              alt: row.alt?.trim() || 'Logo',
            }))
            .filter((item) => item.src && item.src.length > 0); // Usuń puste/inwalidne

          if (config.logos.length === 0) {
            console.error('Brak ważnych logotypów w CSV. Sprawdź plik.');
            return;
          }

          // Inicjalizuj karuzelę po załadowaniu danych (asynchronicznie)
          fillLogos().then(() => {
            animate(); // Uruchom animację po pełnym załadowaniu
            console.log('Karuzela zainicjalizowana z', config.logos.length, 'logotypami.');
          }).catch((error) => {
            console.error('Błąd podczas wypełniania karuzeli:', error);
          });
        },
        error: (error, file) => {
          console.error('Błąd ładowania lub parsowania CSV:', error, file);
        },
      });

    })();
  </script>
</section>

<section id="buy" class="buy">
  <h2>Gdzie kupić</h2>
  <div class="buy-links"></div>
  <script>
    // Funkcja do ładowania i parsowania CSV

    function isValidUrl(string) {
      try {
        const url = new URL(string);
        return url.protocol === 'http:' || url.protocol === 'https:';
      } catch (_) {
        return false;
      }
    }

    function sanitizeString(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function isValidPathOrUrl(path) {
      // Sprawdź czy to pełny URL (http/https)
      try {
        const url = new URL(path);
        return url.protocol === 'http:' || url.protocol === 'https:';
      } catch (_) {
        // Jeśli nie jest URL-em, traktujemy jako ścieżkę względną/absolutną
        return typeof path === 'string' && path.trim().length > 0;
      }
    }


    function loadStoresFromCSV() {
      if (typeof Papa === 'undefined') {
        console.error('Biblioteka PapaParse nie jest załadowana.');
        const buyLinks = document.querySelector('.buy-links');
        if (buyLinks) {
          buyLinks.innerHTML = '<p>Nie udało się załadować listy sklepów.</p>';
        }
        return;
      }
      const cached = localStorage.getItem('storesData');
      const cacheTime = localStorage.getItem('storesCacheTime');
      const cacheDuration = 0 *  60 * 60 * 1000; // 6 godzin w milisekundach
      if (cached && cacheTime && (Date.now() - parseInt(cacheTime) < cacheDuration)) {
        // Cache jest świeży, użyj go
        try {
          const data = JSON.parse(cached);
          renderStores(data);
          return;
        } catch (e) {
          console.warn('Nieprawidłowy cache:', e);
          localStorage.removeItem('storesData');
          localStorage.removeItem('storesCacheTime');
        }
      }

      // Jeśli brak cache'u, pobierz CSV
      const csvPath = 'main/csv/stores.csv';

      // Użyj PapaParse do pobrania i parsowania CSV
      Papa.parse(csvPath, {
        download: true, // Pobiera plik jeśli jest zdalny; dla lokalnego też działa
        header: true,   // Pierwsza linia to nagłówki
        skipEmptyLines: true,
        complete: function(results) {
          const buyLinks = document.querySelector('.buy-links');
          if (!buyLinks) {
            console.error('Element .buy-links nie istnieje.');
            return;
          }
          if (results.data.length > 0) {
            try {
              localStorage.setItem('storesData', JSON.stringify(results.data));
              localStorage.setItem('storesCacheTime', Date.now());
            } catch (e) {
              console.warn('Nie można zapisać danych do localStorage:', e);
            }
            renderStores(results.data);
          } else {
            buyLinks.innerHTML = '<p>Brak dostępnych danych w pliku.</p>';
          }
        },
        error: function(error) {
          console.error('Błąd podczas ładowania CSV:', error);
          const buyLinks = document.querySelector('.buy-links');
          if (buyLinks) {
            buyLinks.innerHTML = '<p>Nie udało się załadować listy sklepów: ' + String(error) + '</p>';
          }
        }
      });
    }

    function renderStores(data) {
      const buyLinks = document.querySelector('.buy-links');
      if (!buyLinks) {
        console.error('Element .buy-links nie istnieje.');
        return;
      }
      buyLinks.innerHTML = '';


      const imageBasePath = 'main/img/'; // <-- stały katalog dla obrazków
      let validRows = 0;
      data.forEach(function(row) {
        const sanitizedLink = sanitizeString(row.link);
        const sanitizedImage = sanitizeString(row.image);
        
        if (row.image && row.link && isValidUrl(row.link)) {
          validRows++;
          const span = document.createElement('span');
          span.className = 'container';

          const a = document.createElement('a');
          a.href = sanitizedLink;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.setAttribute('aria-label', `Przejdź do sklepu ${row.alt || row.link}`);

          const img = document.createElement('img');
          img.src = isValidUrl(sanitizedImage) ? sanitizedImage : imageBasePath + sanitizedImage;
          img.alt = row.alt || `Logo sklepu ${row.link}`; //  Domyślny alt jeśli brak zdjęcia
          img.setAttribute('loading', 'lazy'); 
          img.setAttribute('aria-hidden', 'true');

          a.appendChild(img);
          span.appendChild(a);
          buyLinks.appendChild(span);
        } else {
          console.warn('Nieprawidłowy wiersz w CSV:', row );
        }
      });

      if (validRows === 0) {
        buyLinks.innerHTML = '<p>Brak dostępnych sklepów w tej chwili.</p>';
      }
    }

    // Wywołaj funkcję po załadowaniu strony
    window.addEventListener('DOMContentLoaded', loadStoresFromCSV);
  </script>
</section>

<footer id="contact" role="contentinfo" aria-label="Informacje kontaktowe">
    <div class="contact">
        <h4>Kontakt</h4>
        <p><i class="fa fa-envelope" aria-hidden="true" title="Adres email"></i>Email: <a href="mailto:bspolska@bspolska.com.pl">bspolska@bspolska.com.pl</a></p>
        <p><i class="fa fa-phone" aria-hidden="true" title="numer telefonu"></i>Tel/sms: <a href="tel:+48530288284">530 288 284</a></p>
    </div>
    <div class="address">
        <h4>B & S Polska s.c.</h4>
        <p><i class="fas fa-map-marker-alt"></i> Ul. Batorego 3, 05-083 Topolin</p>
        <p><i class="nip"></i> NIP : 1181863247</p>
    </div>
    <div class="copyright">
        <small> &#169; <script>document.write(new Date().getFullYear())</script> B&S Polska. Wszelkie prawa zastrzeżone.</small>
    </div>
</footer>
</body>
</html>

</body>
</html>