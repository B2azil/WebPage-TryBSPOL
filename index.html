<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>B&S Polska</title>
  <link rel="icon" type="image/png" href="main/img/bspolska.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
    
<header id="main-header">
  <a href="https://b2azil.github.io/WebPage-TryBSPOL/" aria-label="Wróć na początek strony"> <!-- w a href="/" gdy ustawisz juz domene -->
    <img src="img/bspolska.png" alt="Logo B&S Polska" class="logo">
  </a>
  <nav class="desktop-nav">
    <a href="#about" class="nav-link">O nas</a>
    <a href="#portfolio" class="nav-link">Portfolio</a>
    <a href="#buy" class="nav-link">Gdzie kupić</a>
    <a href="#contact" class="nav-link">Kontakt</a>
  </nav>
  <button class="hamburger" aria-label="Otwórz menu" aria-expanded="false">
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
  </button>
  <nav class="mobile-nav">
    <a href="#about" class="nav-link">O nas</a>
    <a href="#portfolio" class="nav-link">Portfolio</a>
    <a href="#buy" class="nav-link">Gdzie kupić</a>
    <a href="#contact" class="nav-link">Kontakt</a>
  </nav>

  <script>
    // Hamburger toggle
    const hamburger = document.querySelector('.hamburger');
    const mobileNav = document.querySelector('.mobile-nav');
    const navLinks = document.querySelectorAll('.nav-link');
    

    hamburger.addEventListener('click', () => {
      mobileNav.classList.toggle('open');
      hamburger.setAttribute('aria-expanded', hamburger.getAttribute('aria-expanded') === 'false' ? 'true' : 'false');
    });

    // Zamknij menu po kliknięciu w link
    navLinks.forEach(link => {
      link.addEventListener('click', () => {
        // Usuń klasę active ze wszystkich linków i dodaj do klikniętego
        navLinks.forEach(l => l.classList.remove('active'));
        link.classList.add('active');

        // Zamknij menu mobilne
        mobileNav.classList.remove('open');
        hamburger.setAttribute('aria-expanded', 'false');
      });
    });

    // Zmniejsz header na scroll
    window.addEventListener('scroll', () => {
      const header = document.getElementById('main-header');
      if (window.scrollY > 50) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
    });
  </script>
</header>


<section id="hero-section">
  <div class="hero" id="hero">
    <div class="hero-bg" id="bg1"></div> <!-- Górny (aktywny) -->
    <div class="hero-bg" id="bg2"></div> <!-- Dolny (następny) -->
    
    <div class="hero-content"> <!-- Kontener na treść, na wierzchu -->
      <img src="img/bspolska.png" class="logo">
      <img id="hero-img" style="display: none;" src="" alt="Initial description"> <!-- Ukryty obraz dla dostępności -->
      <a href="#portfolio" class="hero-cta">Przeglądaj marki</a>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const bg1 = document.getElementById('bg1');
      const bg2 = document.getElementById('bg2');
      const heroImg = document.getElementById('hero-img');

      let activeBg = bg1;
      let inactiveBg = bg2;
      let currentIndex = 0;
      let intervalId = null;

      const intervalTime = 5000;
      const maxRunTime = 1 * 30 * 60 * 1000; // 30 minut

      // Funkcja fallbacku
      function setFallback() {
        const fallback = "fallback.jpg";
        activeBg.style.backgroundImage =
          `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('${fallback}')`;
        if (heroImg) {
          heroImg.src = fallback;
          heroImg.alt = "Domyślne tło";
        }
      }

      // Funkcja zmiany tła
      function changeBackground(images) {
        const nextImage = images[currentIndex];
        inactiveBg.style.backgroundImage =
          `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('${nextImage.url}')`;
        inactiveBg.style.opacity = 1;
        activeBg.style.opacity = 0;

        if (heroImg) {
          heroImg.src = nextImage.url;
          heroImg.alt = nextImage.desc;
        }

        setTimeout(() => {
          [activeBg, inactiveBg] = [inactiveBg, activeBg];
        }, 1000);

        currentIndex = (currentIndex + 1) % images.length;
      }

      // Ładuj CSV
      fetch("main/csv/images.csv")
        .then(response => {
          if (!response.ok) throw new Error("Błąd ładowania CSV");
          return response.text();
        })
        .then(text => {
          const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
          if (lines.length <= 1) {
            console.error("Brak danych w CSV");
            setFallback();
            return;
          }

          // Usuń nagłówek
          lines.shift();

          const images = lines.map(line => {
            const parts = line.split(";");
            if (parts.length < 2) {
              console.warn("Niepoprawna linia:", line);
              return null;
            }
            return { url: parts[0].trim(), desc: parts.slice(1).join(";").trim() };
          }).filter(Boolean);

          if (images.length === 0) {
            console.error("Brak poprawnych obrazów");
            setFallback();
            return;
          }

          // Inicjalizacja pierwszego tła
          activeBg.style.backgroundImage =
            `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('${images[0].url}')`;
          activeBg.style.opacity = 1;
          inactiveBg.style.opacity = 0;
          if (heroImg) {
            heroImg.src = images[0].url;
            heroImg.alt = images[0].desc;
          }
          currentIndex = 1;

          // Uruchom interwał, jeśli więcej niż 1 obraz
          if (images.length > 1) {
            intervalId = setInterval(() => changeBackground(images), intervalTime);
          }

          // Preload obrazów
          images.forEach(item => {
            const img = new Image();
            img.src = item.url;
            img.onerror = () => console.warn("Nie udało się załadować:", item.url);
          });

          // Limit działania
          setTimeout(() => {
            if (intervalId) {
              clearInterval(intervalId);
              console.log("Interwał zatrzymany po 2h");
            }
          }, maxRunTime);

          // Pauza, gdy karta nieaktywna
          document.addEventListener("visibilitychange", () => {
            if (document.hidden && intervalId) {
              clearInterval(intervalId);
              intervalId = null;
              console.log("Interwał zatrzymany (karta nieaktywna)");
            } else if (!document.hidden && !intervalId && images.length > 1) {
              intervalId = setInterval(() => changeBackground(images), intervalTime);
              console.log("Interwał wznowiony (karta aktywna)");
            }
          });
        })
        .catch(err => {
          console.error("Błąd fetch:", err);
          setFallback();
        });
    });
  </script>
</section>

<section id="about" class="about">
    <h2>O nas</h2>
    <p>Sklep oferuje dobrej jakości i w umiarkowanych cenach tekstylia szkolne. Jest wieloletnim, doświadczonym i rzetelnym dostawcą marek licencyjnych jak i własnych.</p>
</section>


<section id="portfolio">
  <h2>Nasze Portfolio</h2>
  <div class="brand-grid">
    <p class="loading">Ładowanie marek...</p>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const gridContainer = document.querySelector('.brand-grid');

      // Funkcja slugify (bezpieczne URL)
      function slugify(text) {
          const map = {
          'ą':'a','ć':'c','ę':'e','ł':'l','ń':'n',
          'ó':'o','ś':'s','ź':'z','ż':'z',
          'Ą':'a','Ć':'c','Ę':'e','Ł':'l','Ń':'n',
          'Ó':'o','Ś':'s','Ź':'z','Ż':'z'
          };
        return String(text || '')
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // pozostałe akcenty
          .replace(/[ąćęłńóśźżĄĆĘŁŃÓŚŹŻ]/g, m => map[m] || m) // zamiana PL znaków
          .toLowerCase()
          .replace(/\s+/g, '-')            // spacje → -
          .replace(/[^\w-]+/g, '')         // inne znaki
          .replace(/--+/g, '-')            // wielokrotne - do jednego
          .replace(/^-+|-+$/g, '');        // usunięcie - z początku/końca
      }

      // Walidacja kolorów
      function isValidColor(str) {
        const s = new Option().style;
        s.color = str;
        return s.color !== '';
      }

      // Tworzenie kafelka marki
      function createBrandTile(row) {
        if (!row.name) return null; // pomijamy wiersze bez nazwy

        const tile = document.createElement('a');
        tile.className = 'brand-tile';

        // Generowanie linku na podstawie sluga
        const slug = slugify(row.name) || 'unknown';
        tile.href = `brand.html?brand=${encodeURIComponent(slug)}`;
        tile.setAttribute("aria-label", row.name);
        tile.setAttribute('title', `Przejdź do listy produktów marki ${row.name}`);

        // Ustawienie kolorów z fallbackami
        tile.style.setProperty('--color1', row.color1 && isValidColor(row.color1) ? row.color1 : '#f9f9f9');
        tile.style.setProperty('--color2', row.color2 && isValidColor(row.color2) ? row.color2 : '#f9f9f9');
        tile.style.setProperty('--color3', row.color3 && isValidColor(row.color3) ? row.color3 : '#f9f9f9');


        // Nazwa marki
        const nameSpan = document.createElement('span');
        nameSpan.textContent = row.name;
        tile.appendChild(nameSpan);

        return tile;
      }
      // Główna funkcja ładowania i renderowania
      async function loadBrands() {
        const gridContainer = document.querySelector('.brand-grid'); // Przeniesione tutaj dla spójności

        try {
          const response = await fetch('main/csv/brands.csv');
          if (!response.ok) throw new Error('Nie udało się załadować pliku CSV');

          const text = await response.text();
          const results = Papa.parse(text, { 
            header: true, 
            skipEmptyLines: true,
            delimiter: ";" 
          });


          if (results.errors.length > 0) {
            throw new Error('Błąd parsowania CSV: ' + results.errors[0].message);
          }

          gridContainer.innerHTML = ''; // Wyczyszczenie "Ładowanie..."

          const fragment = document.createDocumentFragment();

          results.data.forEach(row => {
            const tile = createBrandTile(row);
            if (tile) fragment.appendChild(tile);
          });

          gridContainer.appendChild(fragment);
        } catch (error) {
          console.error('Błąd:', error);
          gridContainer.innerHTML = '<p>❌ Nie udało się załadować marek.</p>';
        }
      }

      // Wywołanie funkcji bezpośrednio (zamiast drugiego listenera)
      loadBrands();
    });
  </script>
</section>

<section id="carousel">
  <div class="logo-carousel">
    <div class="logo-track" id="logoTrack"></div>
  </div>
<script>
    (function () {
      const config = {
        csvUrl: 'main/csv/carousel.csv', // Ścieżka do pliku CSV
        imageBasePath: 'main/img/', // Prefiks dla wszystkich obrazów
        fallbackImage: 'main/img/fallback-logo.png', // Zastępczy obraz w folderze main/img
        speed: 1.2, // px na klatkę (prędkość animacji)
        direction: 'left', // 'left' lub 'right'
        logos: [], // Będzie wypełnione po parsowaniu CSV
        cycleWidth: 0, // Szerokość jednego cyklu (obliczona dynamicznie po załadowaniu obrazów)
      };

      const carousel = document.getElementById('logoTrack');
      const wrapper = carousel?.parentNode;

      // Walidacja elementów DOM
      if (!carousel || !wrapper) {
        console.error('Nie znaleziono elementów karuzeli (logoTrack) lub wrappera (logo-carousel). Sprawdź HTML.');
        return;
      }

      // Funkcja debounce dla optymalizacji resize
      function debounce(fn, wait) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => fn.apply(this, args), wait);
        };
      }

      // Asynchroniczna funkcja wypełniania logotypów (z czekaniem na załadowanie obrazów)
      async function fillLogos() {
        if (config.logos.length === 0) {
          console.error('Brak logotypów do załadowania. Sprawdź CSV.');
          return;
        }

        let repetitions = 0;
        carousel.innerHTML = ''; // Wyczyść
        const allImgs = []; // Zbieraj obrazy do czekania na onload

        // Pętla do powielania aż tor będzie wystarczająco długi
        do {
          config.logos.forEach((item) => {
            const img = document.createElement('img');
            img.src = item.src;
            img.alt = item.alt || 'Logo'; // Domyślny alt z CSV lub fallback
            img.onerror = () => {
              console.warn(`Błąd ładowania obrazu: ${item.src}. Używam fallback.`);
              img.src = config.fallbackImage;
            };
            carousel.appendChild(img);
            allImgs.push(img); // Dodaj do listy do czekania
          });
          repetitions++;
        } while (carousel.scrollWidth < wrapper.offsetWidth * 2);

        // Czekaj na załadowanie wszystkich obrazów (lub błędy)
        await Promise.all(allImgs.map(img => new Promise((resolve) => {
          img.onload = resolve;
          img.onerror = resolve; // Kontynuuj nawet po błędzie
          if (img.complete) resolve(); // Jeśli już załadowany (z cache)
        })));

        // Po załadowaniu: Oblicz szerokość jednego cyklu precyzyjnie
        config.cycleWidth = carousel.scrollWidth / repetitions;
        console.log(`Wypełniono karuzelę: ${repetitions} powtórzeń, cycleWidth: ${config.cycleWidth}px (po załadowaniu obrazów)`);
      }

      // Funkcja animacji (z konfigurowalnym kierunkiem i precyzyjnym resetem)
      let position = 0;
      let speedLocked = false;

      function animate() {
        if (!speedLocked && config.cycleWidth > 0) {
          const effectiveSpeed = config.direction === 'left' ? -config.speed : config.speed;
          position += effectiveSpeed;

          // Precyzyjny reset pozycji dla płynnego zapętlania
          if (config.direction === 'left') {
            if (position <= -config.cycleWidth) {
              position += config.cycleWidth; // Dodaj cycleWidth zamiast =0, aby uniknąć przeskoku
            }
          } else {
            if (position >= config.cycleWidth) {
              position -= config.cycleWidth;
            }
          }
        }
        carousel.style.transform = `translateX(${position}px)`;
        requestAnimationFrame(animate);
      }

      // Obsługa hover (zatrzymanie animacji)
      wrapper.addEventListener('mouseenter', () => {
        speedLocked = true;
      });
      wrapper.addEventListener('mouseleave', () => {
        speedLocked = false;
      });

      // Obsługa dotyku (swipe dla mobilnych z lepszym ograniczeniem pozycji)
      let touchStartX = 0;
      wrapper.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
        speedLocked = true;
      });
      wrapper.addEventListener('touchmove', (e) => {
        e.preventDefault(); // Zapobiegaj scrollowi strony
        const touchX = e.touches[0].clientX;
        const deltaX = touchX - touchStartX;
        position += deltaX; // Zwiększona wrażliwość dla lepszego swipe (dostosuj jeśli za szybko)
        touchStartX = touchX;

        // Ogranicz pozycję do zakresu cyklu, aby uniknąć przeskoków poza granicami
        position = ((position % config.cycleWidth) + config.cycleWidth) % config.cycleWidth;
        if (config.direction === 'left' && position > 0) position -= config.cycleWidth;

        carousel.style.transform = `translateX(${position}px)`;
      });
      wrapper.addEventListener('touchend', () => {
        speedLocked = false;
      });

      // Obsługa resize okna (ponowne asynchroniczne wypełnienie karuzeli)
      const debouncedResize = debounce(async () => {
        await fillLogos();
        // Reset pozycji po resize, aby uniknąć przeskoków
        position = 0;
      }, 200);
      window.addEventListener('resize', debouncedResize);

      // Ładowanie i parsowanie CSV za pomocą PapaParse
      Papa.parse(config.csvUrl, {
        download: true, // Pobierz plik zdalnie/lokalnie
        header: true, // Użyj pierwszej linii jako nagłówki (image, alt)
        skipEmptyLines: true, // Pomiń puste wiersze
        dynamicTyping: false, // Traktuj wszystko jako stringi
        complete: (results) => {
          console.log('CSV załadowany pomyślnie:', results.data.length, 'wierszy');
          if (results.errors && results.errors.length > 0) {
            console.error('Błędy parsowania CSV:', results.errors);
            return;
          }
          // Przetwórz dane: filtruj puste src i stwórz tablicę obiektów
          config.logos = results.data
            .map((row) => ({
              src: row.image?.trim() ? `${config.imageBasePath}${row.image.trim()}` : '', // Dodaj prefiks
              alt: row.alt?.trim() || 'Logo',
            }))
            .filter((item) => item.src && item.src.length > 0); // Usuń puste/inwalidne

          if (config.logos.length === 0) {
            console.error('Brak ważnych logotypów w CSV. Sprawdź plik.');
            return;
          }

          // Inicjalizuj karuzelę po załadowaniu danych (asynchronicznie)
          fillLogos().then(() => {
            animate(); // Uruchom animację po pełnym załadowaniu
            console.log('Karuzela zainicjalizowana z', config.logos.length, 'logotypami.');
          }).catch((error) => {
            console.error('Błąd podczas wypełniania karuzeli:', error);
          });
        },
        error: (error, file) => {
          console.error('Błąd ładowania lub parsowania CSV:', error, file);
        },
      });

    })();
  </script>
</section>

<section id="buy" class="buy">
  <h2>Gdzie można nas spotkać</h2>
  <div class="buy-links"></div>
  <script>
    // Funkcja do ładowania i parsowania CSV

    function isValidUrl(string) {
      try {
        const url = new URL(string);
        return url.protocol === 'http:' || url.protocol === 'https:';
      } catch (_) {
        return false;
      }
    }

    function sanitizeString(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function isValidPathOrUrl(path) {
      // Sprawdź czy to pełny URL (http/https)
      try {
        const url = new URL(path);
        return url.protocol === 'http:' || url.protocol === 'https:';
      } catch (_) {
        // Jeśli nie jest URL-em, traktujemy jako ścieżkę względną/absolutną
        return typeof path === 'string' && path.trim().length > 0;
      }
    }


    function loadStoresFromCSV() {
      if (typeof Papa === 'undefined') {
        console.error('Biblioteka PapaParse nie jest załadowana.');
        const buyLinks = document.querySelector('.buy-links');
        if (buyLinks) {
          buyLinks.innerHTML = '<p>Nie udało się załadować listy sklepów.</p>';
        }
        return;
      }
      const cached = localStorage.getItem('storesData');
      const cacheTime = localStorage.getItem('storesCacheTime');
      const cacheDuration = 6 *  60 * 60 * 1000; // 6 godzin w milisekundach
      if (cached && cacheTime && (Date.now() - parseInt(cacheTime) < cacheDuration)) {
        // Cache jest świeży, użyj go
        try {
          const data = JSON.parse(cached);
          renderStores(data);
          return;
        } catch (e) {
          console.warn('Nieprawidłowy cache:', e);
          localStorage.removeItem('storesData');
          localStorage.removeItem('storesCacheTime');
        }
      }

      // Jeśli brak cache'u, pobierz CSV
      const csvPath = 'main/csv/stores.csv';

      // Użyj PapaParse do pobrania i parsowania CSV
      Papa.parse(csvPath, {
        download: true, // Pobiera plik jeśli jest zdalny; dla lokalnego też działa
        header: true,   // Pierwsza linia to nagłówki
        skipEmptyLines: true,
        complete: function(results) {
          const buyLinks = document.querySelector('.buy-links');
          if (!buyLinks) {
            console.error('Element .buy-links nie istnieje.');
            return;
          }
          if (results.data.length > 0) {
            try {
              localStorage.setItem('storesData', JSON.stringify(results.data));
              localStorage.setItem('storesCacheTime', Date.now());
            } catch (e) {
              console.warn('Nie można zapisać danych do localStorage:', e);
            }
            renderStores(results.data);
          } else {
            buyLinks.innerHTML = '<p>Brak dostępnych danych w pliku.</p>';
          }
        },
        error: function(error) {
          console.error('Błąd podczas ładowania CSV:', error);
          const buyLinks = document.querySelector('.buy-links');
          if (buyLinks) {
            buyLinks.innerHTML = '<p>Nie udało się załadować listy sklepów: ' + String(error) + '</p>';
          }
        }
      });
    }

    function renderStores(data) {
      const buyLinks = document.querySelector('.buy-links');
      if (!buyLinks) {
        console.error('Element .buy-links nie istnieje.');
        return;
      }
      buyLinks.innerHTML = '';


      const imageBasePath = 'main/img/'; // <-- stały katalog dla obrazków
      let validRows = 0;
      data.forEach(function(row) {
        const sanitizedLink = sanitizeString(row.link);
        const sanitizedImage = sanitizeString(row.image);
        
        if (row.image && row.link && isValidUrl(row.link)) {
          validRows++;
          const span = document.createElement('span');
          span.className = 'container';

          const a = document.createElement('a');
          a.href = sanitizedLink;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.setAttribute('aria-label', `Przejdź do sklepu ${row.alt || row.link}`);

          const img = document.createElement('img');
          img.src = isValidUrl(sanitizedImage) ? sanitizedImage : imageBasePath + sanitizedImage;
          img.alt = row.alt || `Logo sklepu ${row.link}`; //  Domyślny alt jeśli brak zdjęcia
          img.setAttribute('loading', 'lazy'); 
          img.setAttribute('aria-hidden', 'true');

          a.appendChild(img);
          span.appendChild(a);
          buyLinks.appendChild(span);
        } else {
          console.warn('Nieprawidłowy wiersz w CSV:', row );
        }
      });

      if (validRows === 0) {
        buyLinks.innerHTML = '<p>Brak dostępnych sklepów w tej chwili.</p>';
      }
    }

    // Wywołaj funkcję po załadowaniu strony
    window.addEventListener('DOMContentLoaded', loadStoresFromCSV);
  </script>
</section>

<footer id="contact" role="contentinfo" aria-label="Informacje kontaktowe">
    <div class="contact">
        <h4>Kontakt</h4>
        <p><i class="fa fa-envelope" aria-hidden="true" title="Adres email"></i>Email: <a href="mailto:bspolska@bspolska.com.pl">bspolska@bspolska.com.pl</a></p>
        <p><i class="fa fa-phone" aria-hidden="true" title="numer telefonu"></i>Tel/sms: <a href="tel:+48530288284">530 288 284</a></p>
    </div>
    <div class="address">
        <h4>B & S Polska s.c.</h4>
        <p><i class="fas fa-map-marker-alt"></i> Ul. Batorego 3, 05-083 Topolin</p>
        <p><i class="nip"></i> NIP : 1181863247</p>
    </div>
    <div class="copyright">
        <small> &#169; <script>document.write(new Date().getFullYear())</script> B&S Polska. Wszelkie prawa zastrzeżone.</small>
    </div>
</footer>
</body>
</html>
