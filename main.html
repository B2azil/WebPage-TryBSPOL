<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>B&S Polska</title>
    <link rel="icon" href="img/bspolska.png">
    <meta name="description" content="">
    <!-- <link rel="stylesheet" href="css/reset.css"> -->
    <link rel="stylesheet" href="css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
    
  <header>
      <div class="logo"><img src="img\bspolska.png" class="logo"></div>
      <nav>
          <a href="#about">O nas</a>
          <a href="#portfolio">Portfolio</a>
          <a href="#buy">Gdzie kupić</a>
          <a href="#contact">Kontakt</a>
      </nav>
  </header>


<section id="hero-section">
  <div class="hero" id="hero">
    <div class="hero-bg" id="bg1"></div> <!-- Górny (aktywny) -->
    <div class="hero-bg" id="bg2"></div> <!-- Dolny (następny) -->
    
    <div class="hero-content"> <!-- Kontener na treść, na wierzchu -->
      <img src="img/bspolska.png" class="logo">
      <img id="hero-img" style="display: none;" src="" alt="Initial description"> <!-- Ukryty obraz dla dostępności -->
      <a href="#portfolio" class="hero-cta">Przeglądaj marki</a>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const bg1 = document.getElementById('bg1');
      const bg2 = document.getElementById('bg2');
      const heroImg = document.getElementById('hero-img');

      let activeBg = bg1;
      let inactiveBg = bg2;
      let currentIndex = 0;
      let intervalId = null;

      const intervalTime = 5000;
      const maxRunTime = 1 * 30 * 60 * 1000; // 30 minut

      // Funkcja fallbacku
      function setFallback() {
        const fallback = "fallback.jpg";
        activeBg.style.backgroundImage =
          `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('${fallback}')`;
        if (heroImg) {
          heroImg.src = fallback;
          heroImg.alt = "Domyślne tło";
        }
      }

      // Funkcja zmiany tła
      function changeBackground(images) {
        const nextImage = images[currentIndex];
        inactiveBg.style.backgroundImage =
          `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('${nextImage.url}')`;
        inactiveBg.style.opacity = 1;
        activeBg.style.opacity = 0;

        if (heroImg) {
          heroImg.src = nextImage.url;
          heroImg.alt = nextImage.desc;
        }

        setTimeout(() => {
          [activeBg, inactiveBg] = [inactiveBg, activeBg];
        }, 1000);

        currentIndex = (currentIndex + 1) % images.length;
      }

      // Ładuj CSV
      fetch("main/images.csv")
        .then(response => {
          if (!response.ok) throw new Error("Błąd ładowania CSV");
          return response.text();
        })
        .then(text => {
          const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
          if (lines.length <= 1) {
            console.error("Brak danych w CSV");
            setFallback();
            return;
          }

          // Usuń nagłówek
          lines.shift();

          const images = lines.map(line => {
            const parts = line.split(";");
            if (parts.length < 2) {
              console.warn("Niepoprawna linia:", line);
              return null;
            }
            return { url: parts[0].trim(), desc: parts.slice(1).join(";").trim() };
          }).filter(Boolean);

          if (images.length === 0) {
            console.error("Brak poprawnych obrazów");
            setFallback();
            return;
          }

          // Inicjalizacja pierwszego tła
          activeBg.style.backgroundImage =
            `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('${images[0].url}')`;
          activeBg.style.opacity = 1;
          inactiveBg.style.opacity = 0;
          if (heroImg) {
            heroImg.src = images[0].url;
            heroImg.alt = images[0].desc;
          }
          currentIndex = 1;

          // Uruchom interwał, jeśli więcej niż 1 obraz
          if (images.length > 1) {
            intervalId = setInterval(() => changeBackground(images), intervalTime);
          }

          // Preload obrazów
          images.forEach(item => {
            const img = new Image();
            img.src = item.url;
            img.onerror = () => console.warn("Nie udało się załadować:", item.url);
          });

          // Limit działania
          setTimeout(() => {
            if (intervalId) {
              clearInterval(intervalId);
              console.log("Interwał zatrzymany po 2h");
            }
          }, maxRunTime);

          // Pauza, gdy karta nieaktywna
          document.addEventListener("visibilitychange", () => {
            if (document.hidden && intervalId) {
              clearInterval(intervalId);
              intervalId = null;
              console.log("Interwał zatrzymany (karta nieaktywna)");
            } else if (!document.hidden && !intervalId && images.length > 1) {
              intervalId = setInterval(() => changeBackground(images), intervalTime);
              console.log("Interwał wznowiony (karta aktywna)");
            }
          });
        })
        .catch(err => {
          console.error("Błąd fetch:", err);
          setFallback();
        });
    });
  </script>

</section>


  <section id="about" class="about">
      <h2>O nas</h2>
      <p>Sklep oferuje dobrej jakości i w umiarkowanych cenach tekstylia szkolne. Jest wieloletnim, doświadczonym i rzetelnym dostawcą marek licencyjnych jak i własnych.</p>
  </section>


<section id="portfolio">
  <h2>Nasze Portfolio</h2>
  <div class="brand-grid">
    <p class="loading">Ładowanie marek...</p>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const gridContainer = document.querySelector('.brand-grid');

      // Funkcja slugify (bezpieczne URL)
      function slugify(text) {
          const map = {
          'ą':'a','ć':'c','ę':'e','ł':'l','ń':'n',
          'ó':'o','ś':'s','ź':'z','ż':'z',
          'Ą':'a','Ć':'c','Ę':'e','Ł':'l','Ń':'n',
          'Ó':'o','Ś':'s','Ź':'z','Ż':'z'
          };
        return String(text || '')
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // pozostałe akcenty
          .replace(/[ąćęłńóśźżĄĆĘŁŃÓŚŹŻ]/g, m => map[m] || m) // zamiana PL znaków
          .toLowerCase()
          .replace(/\s+/g, '-')            // spacje → -
          .replace(/[^\w-]+/g, '')         // inne znaki
          .replace(/--+/g, '-')            // wielokrotne - do jednego
          .replace(/^-+|-+$/g, '');        // usunięcie - z początku/końca
      }

      // Walidacja kolorów
      function isValidColor(str) {
        const s = new Option().style;
        s.color = str;
        return s.color !== '';
      }

      // Nowa funkcja do tworzenia kafelka (przeniesiona z Twojego kodu dla lepszej organizacji)
      function createBrandTile(row) {
        if (!row.name) return null; // pomijamy wiersze bez nazwy

        const tile = document.createElement('a');
        tile.className = 'brand-tile';

        // Generowanie linku na podstawie sluga
        const slug = slugify(row.name) || 'unknown';
        tile.href = `brand.html?brand=${encodeURIComponent(slug)}`;
        tile.setAttribute("aria-label", row.name);
        tile.setAttribute('title', `Przejdź do listy produktów marki ${row.name}`);

        // Ustawienie kolorów z fallbackami
        tile.style.setProperty('--color1', row.color1 && isValidColor(row.color1) ? row.color1 : '#f9f9f9');
        tile.style.setProperty('--color2', row.color2 && isValidColor(row.color2) ? row.color2 : '#f9f9f9');
        tile.style.setProperty('--color3', row.color3 && isValidColor(row.color3) ? row.color3 : '#f9f9f9');


        // Nazwa marki
        const nameSpan = document.createElement('span');
        nameSpan.textContent = row.name;
        tile.appendChild(nameSpan);

        return tile;
      }

      // Zaktualizowana funkcja loadBrands (z Twojej propozycji, zintegrowana z logiką tworzenia kafelków)
      async function loadBrands() {
        const gridContainer = document.querySelector('.brand-grid'); // Przeniesione tutaj dla spójności

        try {
          const response = await fetch('main/brands.csv');
          if (!response.ok) throw new Error('Nie udało się załadować pliku CSV');

          const text = await response.text();
          const results = Papa.parse(text, { header: true, skipEmptyLines: true });

          if (results.errors.length > 0) {
            throw new Error('Błąd parsowania CSV: ' + results.errors[0].message);
          }

          gridContainer.innerHTML = ''; // Wyczyszczenie "Ładowanie..."

          const fragment = document.createDocumentFragment();

          results.data.forEach(row => {
            const tile = createBrandTile(row);
            if (tile) fragment.appendChild(tile);
          });

          gridContainer.appendChild(fragment);
        } catch (error) {
          console.error('Błąd:', error);
          gridContainer.innerHTML = '<p>❌ Nie udało się załadować marek.</p>';
        }
      }

      // Wywołanie funkcji bezpośrednio (zamiast drugiego listenera)
      loadBrands();
    });
  </script>
</section>

<section id="carousel">
  <div class="logo-carousel">
    <div class="logo-track" id="logoTrack"></div>
  </div>
  <script>
    const LOGOS = [
      "https://upload.wikimedia.org/wikipedia/en/6/6d/Legia_Warsaw_logo.svg",
      "img/1SO logo.jpg",
      "https://football-logos.cc/logos/poland/700x700/lech-poznan.png",
      "img/TE logo.jpg",
      "https://upload.wikimedia.org/wikipedia/de/8/81/Pogon_Szczecin.svg",
    ];

    // Duplikujemy logo aby płynnie zapętlić przesuwanie
    const carousel = document.getElementById('logoTrack');
    const wrapper = carousel.parentNode;

    function fillLogos() {
      const baseLogos = [...LOGOS];
      carousel.innerHTML = '';
      let repetitions = 2;
      do {
        baseLogos.forEach(src => {
          const img = document.createElement('img');
          img.src = src;
          carousel.appendChild(img);
        });
        repetitions++;
      } while (carousel.scrollWidth < wrapper.offsetWidth * 2); // powielamy aż "tor" jest dużo dłuższy od widoku
    }
    fillLogos();

    // Płynne przesuwanie
    let position = 0;
    const speed = 1.2; // px na klatkę (zmień w razie potrzeby)
    let speedLocked = false;

    function animate() {
      if (!speedLocked) position -= speed;
      const logoWidth = carousel.scrollWidth / 2;
      if (Math.abs(position) >= logoWidth) position = 0;
      carousel.style.transform = `translateX(${position}px)`;
      requestAnimationFrame(animate);
    }

    // Obsługa zatrzymania na hover
    carousel.parentNode.addEventListener('mouseenter', () => speedLocked = true);
    carousel.parentNode.addEventListener('mouseleave', () => speedLocked = false);

    animate();
  </script>
</section>

<section id="buy" class="buy">
  <h2>Gdzie można nas spotkać</h2>
  <div class="buy-links"></div>
  <script>
    // Funkcja do ładowania i parsowania CSV
    function isValidUrl(string) {
      try {
        const url = new URL(string);
        return url.protocol === 'http:' || url.protocol === 'https:';
      } catch (_) {
        return false;
      }
    }

    function sanitizeString(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function loadStoresFromCSV() {
      if (typeof Papa === 'undefined') {
        console.error('Biblioteka PapaParse nie jest załadowana.');
        const buyLinks = document.querySelector('.buy-links');
        if (buyLinks) {
          buyLinks.innerHTML = '<p>Nie udało się załadować listy sklepów.</p>';
        }
        return;
      }
      const cached = localStorage.getItem('storesData');
      const cacheTime = localStorage.getItem('storesCacheTime');
      const cacheDuration = 6 * 60 * 60 * 1000; // 6 godzin w milisekundach
      if (cached && cacheTime && (Date.now() - parseInt(cacheTime) < cacheDuration)) {
        // Cache jest świeży, użyj go
        try {
          const data = JSON.parse(cached);
          renderStores(data);
          return;
        } catch (e) {
          console.warn('Nieprawidłowy cache:', e);
          localStorage.removeItem('storesData');
          localStorage.removeItem('storesCacheTime');
        }
      }

      // Jeśli brak cache'u, pobierz CSV
      const csvPath = 'main/stores.csv';

      // Użyj PapaParse do pobrania i parsowania CSV
      Papa.parse(csvPath, {
        download: true, // Pobiera plik jeśli jest zdalny; dla lokalnego też działa
        header: true,   // Pierwsza linia to nagłówki
        skipEmptyLines: true,
        complete: function(results) {
          const buyLinks = document.querySelector('.buy-links');
          if (!buyLinks) {
            console.error('Element .buy-links nie istnieje.');
            return;
          }
          if (results.data.length > 0) {
            try {
              localStorage.setItem('storesData', JSON.stringify(results.data));
              localStorage.setItem('storesCacheTime', Date.now());
            } catch (e) {
              console.warn('Nie można zapisać danych do localStorage:', e);
            }
            renderStores(results.data);
          } else {
            buyLinks.innerHTML = '<p>Brak dostępnych danych w pliku.</p>';
          }
        },
        error: function(error) {
          console.error('Błąd podczas ładowania CSV:', error);
          const buyLinks = document.querySelector('.buy-links');
          if (buyLinks) {
            buyLinks.innerHTML = '<p>Nie udało się załadować listy sklepów: ' + String(error) + '</p>';
          }
        }
      });
    }

    function renderStores(data) {
      const buyLinks = document.querySelector('.buy-links');
      if (!buyLinks) {
        console.error('Element .buy-links nie istnieje.');
        return;
      }
      buyLinks.innerHTML = '';
      
      // Dla każdej linii CSV utwórz element HTML
      let validRows = 0;
      data.forEach(function(row) {
        const sanitizedLink = sanitizeString(row.link);
        const sanitizedImage = sanitizeString(row.image);
        if (row.image && row.link && isValidUrl(row.link) && isValidUrl(row.image) && isValidUrl(sanitizedLink) && isValidUrl(sanitizedImage)) {
          validRows++;
          const span = document.createElement('span');
          span.className = 'container';

          const a = document.createElement('a');
          a.href = sanitizedLink;
          a.target = '_blank';
          a.rel = 'noopener noreferrer'; // Poprawka bezpieczeństwa
          a.setAttribute('aria-label', `Przejdź do sklepu ${row.alt || row.link}`);

          const img = document.createElement('img');
          img.src = sanitizedImage;
          img.alt = row.alt || `Logo sklepu ${row.link}`; //  Domyślny alt jeśli brak zdjęcia
          img.setAttribute('loading', 'lazy'); 
          img.setAttribute('aria-hidden', 'true');

          a.appendChild(img);
          span.appendChild(a);
          buyLinks.appendChild(span);
        } else {
          console.warn('Nieprawidłowy wiersz w CSV:', row );
        }
      });

      if (validRows === 0) {
        buyLinks.innerHTML = '<p>Brak dostępnych sklepów w tej chwili.</p>';
      }
    }

    // Wywołaj funkcję po załadowaniu strony
    window.addEventListener('DOMContentLoaded', loadStoresFromCSV);
  </script>
</section>

<footer id="contact">
    <div class="contact">
        <h4>Kontakt</h4>
        <p>Email: kontakt@twojsklep.pl</p>
        <p>Telefon: 123-456-789</p>
    </div>
    <div class="address">
        <h4>Adres</h4>
        <p>Ul. Batorego 3, 05-083 Topolin</p>
    </div>
</footer>
</body>
</html>
